


import React, { useState, useEffect } from "react";
import {
  View,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Modal,
  Text,
  Alert,
} from "react-native";
import Svg, { G, Circle } from "react-native-svg";
import { List } from "react-native-paper";
import AsyncStorage from "@react-native-async-storage/async-storage";
import Ionicons from "react-native-vector-icons/Ionicons";

const CircularProgress = ({
  size,
  strokeWidth,
  progress,
  tintColor,
  zIndex,
}) => {
  const radius = (size - strokeWidth) / 2.3;
  const circumference = radius * 2 * Math.PI;
  const strokeDashoffset = circumference - (progress / 100) * circumference;

  return (
    <View style={[styles.circularProgress, { zIndex }]}>
      <Svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
        <G rotation="-90" origin={`${size / 2}, ${size / 2}`}>
          <Circle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            fill="none"
            stroke="#eee"
            strokeWidth={strokeWidth}
          />
          <Circle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            fill="none"
            stroke={tintColor}
            strokeWidth={strokeWidth}
            strokeDasharray={circumference}
            strokeDashoffset={strokeDashoffset}
            strokeLinecap="round"
          />
        </G>
      </Svg>
    </View>
  );
};

const HomeScreen = () => {
  const [mealFoods, setMealFoods] = useState({
    breakfast: [],
    lunch: [],
    dinner: [],
    snacks: [],
  });

  const mealIcons = {
    breakfast: "egg-fried",
    lunch: "rice",
    dinner: "food-steak",
    snacks: "food-apple-outline",
  };

  const caloriesFill = (509 / 2200) * 100;
  const proteinFill = (17 / 65) * 100;
  const carbsFill = (99 / 325) * 100;
  const fatFill = (7 / 90) * 100;

  const [modalVisible, setModalVisible] = useState(false);
  const [currentMealType, setCurrentMealType] = useState("");
  const [foods, setFoods] = useState([]); // يفترض أن هذا يحمل قائمة الأطعمة المخزنة

  useEffect(() => {
    const loadMealFoods = async () => {
      try {
        const jsonValue = await AsyncStorage.getItem("mealFoods");
        if (jsonValue != null) {
          setMealFoods(JSON.parse(jsonValue));
        }
      } catch (e) {
        Alert.alert("Error", "Failed to load the meal data");
      }
    };

    loadMealFoods();
  }, []);

  const saveMealFoods = async (updatedMeals) => {
    try {
      const jsonValue = JSON.stringify(updatedMeals);
      await AsyncStorage.setItem("mealFoods", jsonValue);
    } catch (e) {
      Alert.alert("Error", "Failed to save the meal data");
    }
  };

  const loadFoods = async () => {
    try {
      const jsonValue = await AsyncStorage.getItem("foods");
      setFoods(jsonValue != null ? JSON.parse(jsonValue) : []);
    } catch (e) {
      Alert.alert("Error", "Failed to load the food data");
    }
  };

  const openModalToAddFood = (mealType) => {
    loadFoods();
    setCurrentMealType(mealType);
    setModalVisible(true);
  };

  const addFoodToMeal = (food) => {
    setMealFoods((prevMealFoods) => {
      const updatedMeals = { ...prevMealFoods };
      updatedMeals[currentMealType].push(food);
      saveMealFoods(updatedMeals); // Save updated meals to AsyncStorage
      return updatedMeals;
    });
  };

  const removeFoodFromMeal = (mealType, index) => {
    setMealFoods((prevMealFoods) => {
      const updatedMeals = { ...prevMealFoods };
      updatedMeals[mealType].splice(index, 1);
      saveMealFoods(updatedMeals); // Save updated meals to AsyncStorage
      return updatedMeals;
    });
  };

  return (
    <ScrollView style={styles.sacc}>
      <View style={styles.container}>
        <View style={styles.fd}>
          <View style={styles.progressContainer}>
            <CircularProgress
              size={160}
              strokeWidth={15}
              progress={caloriesFill}
              tintColor="#FF0000"
              zIndex={1}
            />
            <CircularProgress
              size={120}
              strokeWidth={15}
              progress={proteinFill}
              tintColor="#00FF00"
              zIndex={2}
            />
            <CircularProgress
              size={80}
              strokeWidth={15}
              progress={carbsFill}
              tintColor="#0000FF"
              zIndex={3}
            />
            <CircularProgress
              size={40}
              strokeWidth={15}
              progress={fatFill}
              tintColor="#FFFF00"
              zIndex={4}
            />
          </View>
          <View style={styles.TextContainer}>
            <Text style={styles.Text} variant="titleLarge">
              calories : 0/0
            </Text>
            <Text style={styles.Text} variant="titleLarge">
              protein : 0/0
            </Text>
            <Text style={styles.Text} variant="titleLarge">
              carbs : 0/0
            </Text>
            <Text style={styles.Text} variant="titleLarge">
              fat : 0/0
            </Text>
          </View>
        </View>
        <View style={styles.acc}>
          <List.AccordionGroup>
            {["breakfast", "lunch", "dinner", "snacks"].map(
              (mealType, index) => (
                <List.Accordion
                  title={mealType.charAt(0).toUpperCase() + mealType.slice(1)}
                  id={String(index + 1)}
                  key={index}
                  style={styles.acclist}
                  theme={{ colors: { background: "#0059b3" } }}
                  left={(props) => (
                    <List.Icon
                      {...props}
                      icon={mealIcons[mealType]}
                      color="#ffffff"
                    />
                  )}
                  titleStyle={styles.accordionTitle}
                >
                  <TouchableOpacity
                    style={styles.CAddFoodToMenu}
                    onPress={() => openModalToAddFood(mealType)}
                  >
                    <View style={styles.addFoodButtonContent}>
                      <Text style={styles.AddFoodToMenuText}>Add Food ...</Text>

                      <Ionicons
                        name="add-circle-outline"
                        size={25}
                        color="#00ff00"
                      />
                    </View>
                  </TouchableOpacity>
                  {mealFoods[mealType].map((food, idx) => (
                    <View key={idx} style={styles.foodItemContainer}>
                      <Text style={styles.foodItemText}>{food.name}</Text>
                      <TouchableOpacity
                        onPress={() => removeFoodFromMeal(mealType, idx)}
                      >
                        <Text>
                          <Ionicons
                            name="trash-outline"
                            color={"red"}
                            size={25}
                          />
                        </Text>
                      </TouchableOpacity>
                    </View>
                  ))}
                </List.Accordion>
              )
            )}
          </List.AccordionGroup>
        </View>
        <Modal
          animationType="slide"
          transparent={true}
          visible={modalVisible}
          onRequestClose={() => setModalVisible(false)}
        >
          <View style={styles.modalContainer}>
            {foods.map((food, index) => (
              <TouchableOpacity
                key={index}
                style={styles.foodItem}
                onPress={() => addFoodToMeal(food)}
              >
                <Text>{food.name}</Text>
              </TouchableOpacity>
            ))}
            <TouchableOpacity
              onPress={() => setModalVisible(false)}
              style={{ paddingTop: 20 }}
            >
              <Text>Close</Text>
            </TouchableOpacity>
          </View>
        </Modal>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    backgroundColor: "#003366",
  },
  fd: {
    marginTop: 100,
    width: "90%",
    height: 200,
    borderRadius: 10,
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "center",
    backgroundColor: "#444444",
  },
  sacc: {
    width: "100%",
    backgroundColor: "#003366",
  },
  acc: {
    borderWidth: 1,
    borderColor: "#ffffff",
    width: "95%",
    height: "auto",
    marginTop: 20, 
    borderRadius: 10, 
    overflow: "hidden", 
    backgroundColor: "#444444",
  },
  acclist: {
    borderRadius: 10, 
    backgroundColor: "#0059b3",
    color: "#ffffff",
  },
  accitme: {
    width: "100%",
    marginLeft: 10,
    color: "#000",
  },
  accordionTitle: {
    textAlign: "center",
    color: "#fff",
  },
  progressContainer: {
    position: "relative",
    alignItems: "center",
    justifyContent: "center",
    height: 200,
    width: 200,
    backgroundColor: "#ffffff",
  },
  TextContainer: {
    alignItems: "center",
    justifyContent: "center",
    height: 200,
    width: 200,
    backgroundColor: "gray",
  },
  Text: {
    fontWeight: "bold",
  },
  circularProgress: {
    position: "absolute",
    justifyContent: "center",
    alignItems: "center",
  },
  overlaidProgress: {
    position: "absolute",
    top: 0,
    left: 0,
  },
  addFoodButtonContent: {
    width: "100%",
    flexDirection: "row",
    justifyContent: "space-between",
  },
  AddFoodToMenuText: {
    marginLeft: 5,
    color: "#000",
    fontSize: 16,
    fontWeight: "bold",
  },
  foodItemContainer: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    backgroundColor: "#1E88E5",
    padding: 10,
    borderBottomWidth: 1,
    borderColor: "#ddd",
  },
  CAddFoodToMenu: {
    backgroundColor: "#1E88E5",
    borderBottomWidth: 1,
    borderColor: "#ddd",
    padding: 10,
  },
  modalContainer: {
    marginTop: 50,
    backgroundColor: "white",
    borderRadius: 20,
    padding: 35,
    alignItems: "center",
    shadowColor: "#000",
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
    elevation: 5,
    width: "80%",
    alignSelf: "center",
  },
  foodItem: {
    padding: 10,
    borderBottomWidth: 1,
    borderColor: "#ddd",
  },
  foodItemText: {
    backgroundColor: "#1E88E5",
    color: "#000",
    borderBottomWidth: 1,
    borderColor: "#ffffff",
  },
});

export default HomeScreen;
